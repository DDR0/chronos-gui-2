#!/bin/bash
set -euxo pipefail #enable "safe mode"

#Installing Mock UI and Web Server in a VM:
#   To run this script, SSH onto your virtual machine. Then run this
#   script, taking notes of any comments.
#
#   To SSH into your VM, you may need to first make it.
#       - Grab the debian 9 netinst download iso.
#       - Set up a new VirtualBox VM, set for linux â†’ debian.
#           - Before starting, set up port-forwarding in networking.
#               - name: ssh
#               - protocol: TCP
#               - host IP: 127.0.0.1
#               - host port: 9608 (or whatever)
#               - guest IP: 10.0.2.15 (shown by `ip addr show` later)
#               - guest port: 22
#           - Select the netinst image when prompted for boot media.
#       - Proceed through the text-based installer.
#           - When prompted what components you want, select only the
#             core components and SSH. They should be the bottom two.
#       - Take a snapshot when that's done.
#       - Now, log in as root at the vm prompt and run
#           > vi /etc/ssh/sshd_config
#           - change permit root password login or whatever to yes.
#       - Use ssh-copy-id root@192.168.0.1:9608 (or ssh config alias)
#       - Take another snapshot. (Generally, just do this often, OK?)

# install deps
    apt update && apt-get upgrade --yes
    apt install ntpdate ca-certificates cowsay vim rsync python3-pyqt5 python3-pyqt5.qtsvg curl python3-numpy python3-termcolor --yes
    
    #Python 3.4 doesn't come with the system. We'll make our own, because I can't figure out which PPA I need.
    
    #First, we need to get a compatible version of OpenSSL.
    cd ~
    wget https://www.openssl.org/source/openssl-1.0.2q.tar.gz
    tar xvf openssl-1.0.2q.tar.gz
    cd openssl-1.0.2q
    ./config #to /usr/local/openssl
    make -j$(nproc)
    make install
    
    cd ~
    wget https://www.python.org/ftp/python/3.4.9/Python-3.4.9.tgz
    if [ `md5sum Python-3.4.9.tgz | awk '{print $1;}'` != "c706902881ef95e27e59f13fabbcdcac" ]; then
        echo "INSECURE DOWNLOAD CHECKSUM MISMATCH - SUSPECT TAMPERING"
        mv Python-3.4.9.tgz Python-3.4.9.tgz_INCORRECT_CHECKSUM
        exit
    fi
    tar zxvf Python-3.4.9.tgz
    rm Python-3.4.9.tgz
    cd ~/Python-3.4.9
    apt-get install make build-essential libssl-dev zlib1g-dev libbz2-dev libsqlite3-dev --yes #try to install openssl for pip3
    mkdir buildroot -p
    ./configure --prefix=$PWD/buildroot --enable-ipv6
    make -j$(nproc)
    make install
    

# install the back-of-camera interface & dev environment
    mkdir ~/virtual-camera -p
    ~/Python-3.4.9/buildroot/bin/python3.4 -m venv ~/virtual-camera
    read -sp "Copy chronos-gui-2 over to /opt/camera/chronos-gui-2. Press enter when done. (You can use util/watch-vm-host.sh for this, or do it manually - in my case, I copy-pasted the folder chronos-gui-2 folder from `git checkout && xdg-open .` to fish://root@192.168.0.1:9608 in my file manager, Dolphin. Your setup will probably be different, but as long as you have ~/chronos-gui-2/ with the .py files and a src/ folder in it you should be good.)"
    
    #Set up environment.
    cat >> ~/.bashrc <<'EOL'

#env vars required by QT to run, display, and be touched:
export QSG_RENDER_LOOP=basic
export QT_QPA_PLATFORM=linuxfb:fb=/dev/fb0
export QT_QPA_GENERIC_PLUGINS=tslib:/dev/input/event0

#Make Python 3.4 not choke on unicode characters.
export PYTHONIOENCODING=utf-8
EOL
    
    #Create a few "well-known" files.
    mkdir /opt/camera
    echo "-1" > /opt/camera/serial_number
    echo "Chronos Mock" > /opt/camera/model
    
    #Allow GUI2 to start D-Bus.
    read -sp "Copy ~util/com.krontech.chronos.conf to the camera as noted in it, then press enter."
    
    
    #Install app dependancies.
    #dne for i386: apt install python3-pychronos
    cd ~/virtual-camera
    source bin/activate #turn venv on
    
    python3 -m pip install typing future-fstrings python-periphery
    python3 -m pip install --upgrade setuptools #required for smbus2
    python3 -m pip install smbus2
    
    #Start the app.
    cd /opt/camera/chronos-gui-2 # Wait for the copy to this folder, started earlier, to finish.
    export QT_QPA_PLATFORM=linuxfb:fb=/dev/fb1 #tell qt to use use framebuffer (vs X)
    python3 src/main.py
    
    #QoL
    pip3 install pdbpp watchdog #watchdog provides watchmedo, used for automatic deployment.
    cat >> ~/.pdbrc <<'EOL'
#Refresh the terminal - something disables keyboard echoing when running watch_guest.sh.
import os
os.system("stty sane")
EOL
    
    #Bonus Content - this is NOT required
    
    #ponysay, a cowsay replacement
    cd ~
    wget http://www.vcheng.org/ponysay/ponysay_3.0.2-1_all.deb
    dpkg -i ponysay_3.0.2-1_all.deb
    rm ponysay_3.0.2-1_all.deb
    cat >> /etc/profile.d/horse.sh <<'EOS'
ponysay ++pony aquarius ++pony archlinux ++pony aries ++pony artemis ++pony aurora ++pony barbara ++pony bubbleberry ++pony butterscotch ++pony buttonmom ++pony calamity ++pony cancer ++pony capricorn ++pony childrenofthenight ++pony chrome ++pony coffeetalk ++pony coffeewalk ++pony danger ++pony doctornohat ++pony donutpony ++pony drhooves1 ++pony drhooves10 ++pony drhooves11 ++pony drhooves8 ++pony drhooves9 ++pony drhoovesdiscorded ++pony drizzle ++pony duskshine ++pony elusive ++pony faust ++pony firefox ++pony fluffle ++pony freckles ++pony fyrefly ++pony fyreflyready ++pony gemini ++pony gleamingshield ++pony gnupony ++pony hestelle ++pony internetexplorer ++pony johndelancie ++pony jristz ++pony kingsley ++pony kingsleybanner ++pony leo ++pony libra ++pony littlepip ++pony maandree ++pony milky ++pony milkylay ++pony molestia ++pony nyx ++pony nyxdisguised ++pony opera ++pony orion ++pony oscura ++pony paradise ++pony pinkaminacupcake ++pony pisces ++pony pizzapony ++pony posey ++pony princeartemis ++pony rainbowblitz ++pony reddit ++pony robodash ++pony sagittarius ++pony scorpio ++pony seabreeze ++pony sealyra ++pony slanderpony ++pony snowdrop ++pony snowdrop-crew ++pony solaris ++pony sparkler ++pony starstruck ++pony surprise ++pony sweetiebot ++pony taurus ++pony tempo ++pony ticket ++pony twibrain ++pony virgo ++pony wiggles ++pony woona ++pony woonanohat << EOQ
Hello. Welcome to camera #$(cat /opt/camera/serial_number)! ($(cat /opt/camera/model))
For help and documentation, see http://forum.krontech.ca/ and https://github.com/krontech.
EOQ
EOS
    
    #Faster SSH:
    #If present, edit /etc/profile.d/horse.sh to use /usr/games/cowsay instead
    #   of ponysay. Ponysay takes a *moment* to run. ðŸ˜­
    
    #Static IP
    #Edit the eth0 section in /etc/network/interfaces on the camera like:
    #   auto eth0
    #   iface eth0 inet static
    #           address 192.168.1.214
    #           netmask 255.255.255.0
    #           gateway 192.168.1.1
    #Where "214" is your static IP address choice.